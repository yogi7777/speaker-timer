<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <meta name="author" content="yogi7777">
    <title>Speaker Timer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="dark-mode">
    <div id="timer"></div>
    <button id="resetBtn" class="reset-button">Zurück</button>
    <button id="fullscreenBtn" class="fullscreen-button">⛶</button> <!-- Symbol für Vollbild -->

    <script>
        // Sicherer Zugriff auf URL-Parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sanitizeInput = (value) => {
            const num = parseInt(value, 10);
            return isNaN(num) || num < 0 ? 0 : num;
        };

        // Initiale Werte bereinigen
        let mins = sanitizeInput(urlParams.get('mins'));
        let secs = sanitizeInput(urlParams.get('secs'));
        secs = Math.min(secs, 59);
        let totalSeconds = mins * 60 + secs;

        // Timer-Element initial befüllen
        const timerElement = document.getElementById('timer');
        if (timerElement) {
            timerElement.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        } else {
            console.error("Timer-Element nicht gefunden!");
        }

        // Wake Lock Variablen
        let wakeLock = null;

        // Funktion zum Anfordern des Wake Locks
        const requestWakeLock = async () => {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock aktiviert');
                } else {
                    console.warn('Wake Lock API wird vom Browser nicht unterstützt');
                }
            } catch (err) {
                console.error(`Wake Lock konnte nicht aktiviert werden: ${err.message}`);
            }
        };

        // Funktion zum Freigeben des Wake Locks
        const releaseWakeLock = async () => {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock deaktiviert');
            }
        };

        // Timer-Logik
        let isOvertime = false;
        const resetBtn = document.getElementById('resetBtn');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        // Wake Lock beim Start des Timers aktivieren
        requestWakeLock();
        const timerInterval = setInterval(updateTimer, 1000);

        function updateTimer() {
            if (!isOvertime) {
                totalSeconds--;
                if (totalSeconds <= 0) {
                    totalSeconds = 0;
                    isOvertime = true;
                    document.body.classList.add('overtime');
                }
            } else {
                totalSeconds++;
            }
            updateDisplay();
        }

        function updateDisplay() {
            const absSeconds = Math.abs(totalSeconds);
            const mins = Math.floor(absSeconds / 60);
            const secs = absSeconds % 60;
            if (timerElement) {
                timerElement.textContent = `${isOvertime ? '-' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        // Zurück-Button: Timer stoppen und Wake Lock freigeben
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                clearInterval(timerInterval);
                releaseWakeLock();
                window.location.href = 'index.html';
            });
        }

        // Vollbild-Button: Seite in den Vollbildmodus versetzen
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Fehler beim Aktivieren des Vollbildmodus: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
        }

        // Wake Lock freigeben, wenn die Seite verlassen wird
        window.addEventListener('unload', () => {
            releaseWakeLock();
        });
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92ae6fc70d0e677e',t:'MTc0Mzc0NDg2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>